version: '3.8'

services:
  flux-atlas:
    build:
      context: .
      dockerfile: Dockerfile
    image: littlestache/flux-atlas:3.0
    container_name: flux-atlas
    ports:
      - "3000:3000"  # Serves both frontend and backend API
    volumes:
      - atlas-data:/app/backend/data  # Persist cached atlas builds
    environment:
      - NODE_ENV=production
      - PORT=3000
      - FLUX_UPDATE_INTERVAL=1800000  # 30 minutes
      - FLUX_API_BASE_URL=https://api.runonflux.io
      - FLUX_RPC_TIMEOUT=15000
      - FLUX_MAX_WORKERS=24
      - FLUX_LAYOUT_NODE_CAP=4200
      - FLUX_LAYOUT_SEED=flux-atlas
      - FLUX_INCLUDE_EXTERNAL_PEERS=false
      - FLUX_RPC_PROTOCOL=http
      - FLUX_RPC_PORT=16127
      - FLUX_ALLOW_INSECURE_SSL=true
      - FLUX_ENABLE_ARCANE_PROBE=true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - flux-network

volumes:
  atlas-data:  # Named volume for persistent cache storage

networks:
  flux-network:
    driver: bridge
